<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiny House Rezervasyon Sistemi</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Tiny House Rezervasyon ve Yönetim Sistemi</h1>
    <nav>
      <a href="#">Ana Sayfa</a>
      <a href="#" id="open-login">Giriş</a>
      <a href="#" id="open-register">Kayıt Ol</a>
      <a href="#" id="open-admin-login">Admin Girişi</a>
    </nav>
  </header>
  <main>
    <section class="listing">
      <h2>Evleri Listele</h2>
      <div class="house-list" id="house-list">
        <p>Henüz hiç tiny house ilanı eklenmedi.</p>
      </div>
      <button id="add-house-btn" style="margin-top:20px; display:none;">Yeni Tiny House Ekle</button>
    </section>
    <section class="admin-login modal" id="admin-login" style="display:none">
      <div class="modal-content" style="position:relative;">
        <div style="display:flex;align-items:center;justify-content:center;gap:12px;width:100%;margin-bottom:18px;">
          <h2 style="margin:0;">Admin Girişi</h2>
          <span class="close" data-modal="admin-login" style="cursor:pointer;margin-left:12px;background:#fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.12);padding:2px 16px 6px 16px;font-size:2em;color:#c00;z-index:10;display:inline-block;">&times;</span>
        </div>
        <form>
          <input type="email" name="email" placeholder="Admin E-posta" required>
          <input type="password" name="password" placeholder="Şifre" required>
          <button type="submit">Admin Giriş</button>
        </form>
      </div>
    </section>
    <section class="login modal" id="login" style="display:none">
      <div class="modal-content">
        <span class="close" data-modal="login">&times;</span>
        <h2>Kullanıcı Girişi</h2>
        <form>
          <label for="role">Rol Seçiniz:</label>
          <select id="role" name="role" required>
            <option value="owner">Ev Sahibi</option>
            <option value="tenant">Kiracı</option>
          </select>
          <input type="email" placeholder="E-posta" required>
          <input type="password" placeholder="Şifre" required>
          <button type="submit">Giriş</button>
        </form>
      </div>
    </section>
    <section class="register modal" id="register" style="display:none">
      <div class="modal-content">
        <span class="close" data-modal="register">&times;</span>
        <h2>Kayıt Ol</h2>
        <form>
          <input type="text" placeholder="Ad" required>
          <input type="text" placeholder="Soyad" required>
          <input type="email" placeholder="E-posta" required>
          <input type="password" placeholder="Şifre" required>
          <button type="submit">Kayıt Ol</button>
        </form>
      </div>
    </section>
    <section class="admin-panel" style="display:none">
      <h2>Admin Paneli</h2>
      <div class="dashboard-cards">
        <div class="card">
          <h3>Kullanıcı Yönetimi</h3>
          <ul>
            <li>Kullanıcı ekle</li>
            <li>Kullanıcı düzenle</li>
            <li>Kullanıcı sil</li>
            <li>Kullanıcıyı pasif/aktif yap</li>
            <li>Kullanıcı arama/filtreleme</li>
          </ul>
        </div>
        <div class="card">
          <h3>Rezervasyon Yönetimi</h3>
          <ul>
            <li>Tüm rezervasyonları görüntüle</li>
            <li>Rezervasyon iptal et</li>
            <li>Rezervasyon detaylarını incele</li>
          </ul>
        </div>
        <div class="card">
          <h3>İlan Yönetimi</h3>
          <ul>
            <li>Tüm ilanları listele</li>
            <li>İlan denetle/düzenle/sil</li>
            <li>Kurallara aykırı ilanları kaldır</li>
          </ul>
        </div>
        <div class="card">
          <h3>Ödeme ve Raporlama</h3>
          <ul>
            <li>Finansal raporları görüntüle</li>
            <li>İşlem geçmişini incele</li>
            <li>Kullanıcı ve rezervasyon istatistikleri</li>
          </ul>
        </div>
      </div>
    </section>
    <section class="owner-panel" style="display:none">
      <h2>Ev Sahibi Paneli</h2>
      <div class="dashboard-cards">
        <div class="card">
          <h3>İlan Yönetimi</h3>
          <ul>
            <li>Yeni ilan ekle</li>
            <li>İlan düzenle</li>
            <li>İlanı pasif/aktif yap</li>
            <li>İlan sil</li>
            <li>Fiyat ve uygunluk güncelle</li>
          </ul>
        </div>
        <div class="card">
          <h3>Rezervasyonlar</h3>
          <ul>
            <li>Gelen rezervasyonları gör</li>
            <li>Rezervasyon kabul/ret</li>
            <li>Rezervasyon detaylarını incele</li>
            <li>Geçmiş rezervasyonları görüntüle</li>
          </ul>
        </div>
        <div class="card">
          <h3>Yorumlar</h3>
          <ul>
            <li>Kiracı yorumlarını görüntüle</li>
            <li>Yorumlara cevap ver</li>
          </ul>
        </div>
        <div class="card">
          <h3>Gelir Raporları</h3>
          <ul>
            <li>Ödeme geçmişini görüntüle</li>
            <li>Gelir raporlarını incele</li>
          </ul>
        </div>
      </div>
      <div class="reservation-list"></div>
    </section>
    <section class="tenant-panel" style="display:none">
      <h2>Kiracı Paneli</h2>
      <div class="dashboard-cards">
        <div class="card">
          <h3>Ev Ara ve Listele</h3>
          <ul>
            <li>Ev ara ve filtrele</li>
            <li>Ev detaylarını incele</li>
            <li>Popüler evleri gör</li>
          </ul>
        </div>
        <div class="card">
          <h3>Rezervasyon Yap</h3>
          <ul>
            <li>Tarih seç</li>
            <li>Rezervasyon oluştur</li>
            <li>Online ödeme yap</li>
            <li>Rezervasyon onayını takip et</li>
          </ul>
        </div>
        <div class="card">
          <h3>Rezervasyonlarım</h3>
          <ul>
            <li>Geçmiş rezervasyonları görüntüle</li>
            <li>Aktif rezervasyonları görüntüle</li>
            <li>Rezervasyon iptal et</li>
          </ul>
        </div>
        <div class="card">
          <h3>Yorum ve Puanlama</h3>
          <ul>
            <li>Kiraladığı evlere yorum ekle</li>
            <li>Puan ver</li>
          </ul>
        </div>
      </div>
      <div class="reservation-list"></div>
    </section>
    <script>
      // Modal açma/kapatma
      document.getElementById('open-login').onclick = function(e) {
        e.preventDefault();
        document.getElementById('login').style.display = 'block';
      };
      document.getElementById('open-register').onclick = function(e) {
        e.preventDefault();
        document.getElementById('register').style.display = 'block';
      };
      document.getElementById('open-admin-login').onclick = function(e) {
        e.preventDefault();
        document.getElementById('admin-login').style.display = 'block';
      };
      document.querySelectorAll('.close').forEach(function(btn) {
        btn.onclick = function() {
          document.getElementById(btn.getAttribute('data-modal')).style.display = 'none';
        };
      });
      // Giriş yapan kullanıcıya göre ilan ekleme butonunu göster
      function showAddHouseBtnForRole(role) {
        const btn = document.getElementById('add-house-btn');
        if(role === 'owner' || role === 'admin') {
          btn.style.display = 'inline-block';
        } else {
          btn.style.display = 'none';
        }
      }
      // Admin: Tüm rezervasyonları gör ve iptal et + filtre + ev sahibi ada göre filtre
      function loadAdminReservations(status = 'all', owner = '') {
        fetch('http://localhost:3001/api/admin/reservations?status=' + encodeURIComponent(status) + '&owner=' + encodeURIComponent(owner))
          .then(function(r){ return r.json(); })
          .then(function(data){
            if(!data.success) { alert('Rezervasyonlar alınamadı!'); return; }
            let html = '<h3>Tüm Rezervasyonlar</h3>';
            html += `<label for='admin-res-status'>Duruma göre filtrele: </label>
              <select id='admin-res-status'>
                <option value='all'>Tümü</option>
                <option value='pending'>Beklemede</option>
                <option value='approved'>Onaylandı</option>
                <option value='rejected'>Reddedildi</option>
                <option value='cancelled'>İptal Edildi</option>
                <option value='completed'>Tamamlandı</option>
              </select>
              <label for='admin-owner-filter' style='margin-left:16px;'>Ev Sahibi Ada Göre: </label>
              <input id='admin-owner-filter' type='text' placeholder='Ad veya Soyad' value='${owner || ''}' style='width:120px;'>`;
            data.reservations.forEach(function(r) {
              html += `<div style='border:1px solid #ccc; margin:8px; padding:8px;'>
                <b>${r.title}</b> - ${r.start_date} / ${r.end_date} <br>
                Kiracı: ${r.tenant_first} ${r.tenant_last} <br>
                Ev Sahibi: ${r.owner_first} ${r.owner_last} <br>
                Durum: ${r.status} <br>
                <button onclick="cancelReservation(${r.id})">İptal Et</button>
              </div>`;
            });
            // Sadece rezervasyon listesini güncelle
            const panel = document.querySelector('.admin-panel');
            panel.innerHTML = `<h2>Admin Paneli</h2>` + html;
            // Filtre değişince tekrar yükle
            document.getElementById('admin-res-status').onchange = function() {
              loadAdminReservations(this.value, document.getElementById('admin-owner-filter').value);
            };
            document.getElementById('admin-owner-filter').oninput = function() {
              loadAdminReservations(document.getElementById('admin-res-status').value, this.value);
            };
          });
      }
      // Oturum yönetimi ve arayüz güncelleme
function setLoggedInUser(user) {
  localStorage.setItem('loggedInUser', JSON.stringify(user));
  updateAuthUI();
}
function clearLoggedInUser() {
  localStorage.removeItem('loggedInUser');
  updateAuthUI();
}
function getLoggedInUser() {
  try {
    return JSON.parse(localStorage.getItem('loggedInUser'));
  } catch { return null; }
}
function updateAuthUI() {
  const user = getLoggedInUser();
  const nav = document.querySelector('header nav');
  let userInfo = document.getElementById('user-info');
  if (!userInfo) {
    userInfo = document.createElement('span');
    userInfo.id = 'user-info';
    nav.appendChild(userInfo);
  }
  const loginBtn = document.getElementById('open-login');
  const registerBtn = document.getElementById('open-register');
  const adminLoginBtn = document.getElementById('open-admin-login');
  let logoutBtn = document.getElementById('logout-btn');
  if (!logoutBtn) {
    logoutBtn = document.createElement('a');
    logoutBtn.href = '#';
    logoutBtn.id = 'logout-btn';
    logoutBtn.textContent = 'Çıkış Yap';
    logoutBtn.onclick = function(e) {
      e.preventDefault();
      clearLoggedInUser();
      document.querySelectorAll('.admin-panel, .owner-panel, .tenant-panel').forEach(p=>p.style.display='none');
      showAddHouseBtnForRole('');
    };
    nav.appendChild(logoutBtn);
  }
  if (user) {
    userInfo.textContent = `Hoşgeldin, ${user.first_name}`;
    loginBtn.style.display = 'none';
    registerBtn.style.display = 'none';
    adminLoginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
  } else {
    userInfo.textContent = '';
    loginBtn.style.display = 'inline-block';
    registerBtn.style.display = 'inline-block';
    adminLoginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
  }
}
// Giriş yapan kullanıcı bilgilerini ayarla (örnek: admin girişi sonrası)
// setLoggedInUser({ first_name: 'Admin', role: 'admin' });
      // Panel gösterme (giriş sonrası)
      document.querySelectorAll('.login form, .admin-login form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const isAdmin = form.closest('section').classList.contains('admin-login');
          if(isAdmin) {
            // Admin login: Sadece adminler giriş yapabilsin
            const email = form.querySelector('input[type=email]').value;
            const password = form.querySelector('input[type=password]').value;
            fetch('http://localhost:3001/api/admin/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            })
            .then(r => r.json())
            .then(data => {
              if(data.success && data.role === 'admin') {
                setLoggedInUser({ first_name: 'Admin', role: 'admin', email });
                document.querySelector('.admin-panel').style.display = 'block';
                showAddHouseBtnForRole('admin');
                loadAdminReservations();
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('login').style.display = 'none';
                document.getElementById('register').style.display = 'none';
              } else {
                alert(data.message || 'Sadece adminler giriş yapabilir!');
              }
            })
            .catch(() => alert('Sunucuya bağlanılamadı!'));
            return;
          }
          const role = form.querySelector('select') ? form.querySelector('select').value : '';
          const email = form.querySelector('input[type=email]').value;
          const first_name = email.split('@')[0]; // Sadece örnek için
          if(role === 'owner') {
            setLoggedInUser({ first_name, role: 'owner', email });
            document.querySelector('.owner-panel').style.display = 'block';
            showAddHouseBtnForRole('owner');
            loadOwnerReservations(email);
          } else if(role === 'tenant') {
            setLoggedInUser({ first_name, role: 'tenant', email });
            document.querySelector('.tenant-panel').style.display = 'block';
            showAddHouseBtnForRole('tenant');
            loadTenantReservations(email);
          }
          document.getElementById('admin-login').style.display = 'none';
          document.getElementById('login').style.display = 'none';
          document.getElementById('register').style.display = 'none';
        });
      });
      // Kullanıcı kendi tiny house ilanını ekleyebilsin (sadece owner ve admin)
      document.getElementById('add-house-btn').onclick = function() {
        // Giriş yapan kullanıcının e-posta adresini iste (örnek amaçlı prompt ile)
        const owner_email = prompt('Ev sahibi e-posta adresinizi girin (test için):');
        if (!owner_email) return;
        const houseTitle = prompt('Ev başlığı:');
        if (!houseTitle) return;
        const houseDesc = prompt('Ev açıklaması:');
        if (!houseDesc) return;
        const housePrice = prompt('Gecelik fiyat (TL):');
        if (!housePrice) return;
        const houseLocation = prompt('Ev konumu (şehir):');
        if (!houseLocation) return;
        const houseImg = prompt('Ev resmi için bir görsel linki girin:');
        if (!houseImg) return;
        const availableFrom = prompt('Uygunluk başlangıç tarihi (YYYY-MM-DD):');
        if (!availableFrom) return;
        const availableTo = prompt('Uygunluk bitiş tarihi (YYYY-MM-DD):');
        if (!availableTo) return;
        fetch('http://localhost:3001/api/listings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            owner_email,
            title: houseTitle,
            description: houseDesc,
            price: housePrice,
            location: houseLocation,
            photo_url: houseImg,
            available_from: availableFrom,
            available_to: availableTo
          })
        })
        .then(r => r.json())
        .then(data => {
          if(data.success) {
            alert('İlan başarıyla eklendi!');
            loadListings();
          } else {
            alert(data.message || 'İlan eklenemedi!');
          }
        })
        .catch(() => alert('Sunucuya bağlanılamadı!'));
      };
      // İlanları backend'den çekip listele
      function loadListings() {
        console.log('loadListings çağrıldı'); // DEBUG
        fetch('http://localhost:3001/api/listings')
          .then(r => r.json())
          .then(data => {
            console.log('API listings yanıtı:', data); // DEBUG
            const houseList = document.getElementById('house-list');
            if(!data.success || !data.listings.length) {
              houseList.innerHTML = '<p>Henüz hiç tiny house ilanı eklenmedi.</p>';
              return;
            }
            houseList.innerHTML = '';
            data.listings.forEach(listing => {
              const div = document.createElement('div');
              div.className = 'house';
              div.innerHTML = `
                <img src="${listing.photo_url}" alt="Tiny House">
                <h3>${listing.title}</h3>
                <p>Konum: ${listing.location}</p>
                <p>Fiyat: ${listing.price} TL / gece</p>
                <p>Sahibi: ${listing.first_name} ${listing.last_name}</p>
                <p>Açıklama: ${listing.description || ''}</p>
                <p>Uygunluk: ${listing.available_from} - ${listing.available_to}</p>
                <button class="reserve-btn" data-id="${listing.id}">Rezervasyon Yap</button>
              `;
              houseList.appendChild(div);
            });
            // Rezervasyon butonlarına event ekle
            document.querySelectorAll('.reserve-btn').forEach(btn => {
              btn.onclick = function() {
                const tenant_email = prompt('Kiracı e-posta adresinizi girin:');
                if (!tenant_email) return;
                const start_date = prompt('Başlangıç tarihi (YYYY-MM-DD):');
                if (!start_date) return;
                const end_date = prompt('Bitiş tarihi (YYYY-MM-DD):');
                if (!end_date) return;
                fetch('http://localhost:3001/api/reservations', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    tenant_email,
                    listing_id: btn.getAttribute('data-id'),
                    start_date,
                    end_date
                  })
                })
                .then(r => r.json())
                .then(data => {
                  alert(data.message || (data.success ? 'Rezervasyon talebiniz iletildi!' : 'Rezervasyon başarısız!'));
                })
                .catch(() => alert('Sunucuya bağlanılamadı!'));
              };
            });
          });
      }

      // Ev sahibi: Gelen rezervasyonları gör ve onayla/reddet/iptal et
      function loadOwnerReservations(owner_email) {
        fetch('http://localhost:3001/api/owner/reservations?owner_email=' + encodeURIComponent(owner_email))
          .then(r => r.json())
          .then(data => {
            if(!data.success) { alert('Rezervasyonlar alınamadı!'); return; }
            let html = '<h3>Gelen Rezervasyonlar</h3>';
            data.reservations.forEach(r => {
              html += `<div style='border:1px solid #ccc; margin:8px; padding:8px;'>
                <b>${r.title}</b> - ${r.start_date} / ${r.end_date} <br>
                Kiracı: ${r.tenant_first} ${r.tenant_last} <br>
                Durum: ${r.status} <br>
                <button onclick="ownerApprove(${r.id})">Onayla</button>
                <button onclick="ownerReject(${r.id})">Reddet</button>
                <button onclick="cancelReservation(${r.id})">İptal Et</button>
              </div>`;
            });
            // Sadece .reservation-list içeriğini güncelle
            const panel = document.querySelector('.owner-panel');
            const resList = panel.querySelector('.reservation-list');
            resList.innerHTML = html;
          });
      }
      function ownerApprove(id) {
        fetch('http://localhost:3001/api/reservations/' + id + '/approve', {method:'POST'})
          .then(r=>r.json()).then(data=>{alert(data.message);});
      }
      function ownerReject(id) {
        fetch('http://localhost:3001/api/reservations/' + id + '/reject', {method:'POST'})
          .then(r=>r.json()).then(data=>{alert(data.message);});
      }
      function cancelReservation(id) {
        fetch('http://localhost:3001/api/reservations/' + id + '/cancel', {method:'POST'})
          .then(r=>r.json()).then(data=>{alert(data.message);});
      }
      // Kiracı: Kendi rezervasyonlarını gör ve iptal et
      function loadTenantReservations(tenant_email) {
        fetch('http://localhost:3001/api/tenant/reservations?tenant_email=' + encodeURIComponent(tenant_email))
          .then(r => r.json())
          .then(data => {
            if(!data.success) { alert('Rezervasyonlar alınamadı!'); return; }
            let html = '<h3>Rezervasyonlarım</h3>';
            data.reservations.forEach(r => {
              html += `<div style='border:1px solid #ccc; margin:8px; padding:8px;'>
                <b>${r.title}</b> - ${r.start_date} / ${r.end_date} <br>
                Konum: ${r.location} <br>
                Durum: ${r.status} <br>
                <button onclick="cancelReservation(${r.id})">İptal Et</button>`;
              if(r.status === 'pending') {
                html += ` <button onclick="editReservation(${r.id}, '${tenant_email}', '${r.start_date}', '${r.end_date}')">Düzenle</button>`;
              }
              html += `</div>`;
            });
            // Sadece .reservation-list içeriğini güncelle
            const panel = document.querySelector('.tenant-panel');
            const resList = panel.querySelector('.reservation-list');
            resList.innerHTML = html;
          });
      }
      // Kiracı rezervasyonunu düzenle
      function editReservation(id, tenant_email, oldStart, oldEnd) {
        const start_date = prompt('Yeni başlangıç tarihi (YYYY-MM-DD):', oldStart);
        if (!start_date) return;
        const end_date = prompt('Yeni bitiş tarihi (YYYY-MM-DD):', oldEnd);
        if (!end_date) return;
        fetch('http://localhost:3001/api/reservations/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tenant_email, start_date, end_date })
        })
        .then(r => r.json())
        .then(data => {
          alert(data.message);
          if(data.success) loadTenantReservations(tenant_email);
        })
        .catch(() => alert('Sunucuya bağlanılamadı!'));
      }
      // Kayıt formu submit işlemi (AJAX ile backend'e gönder)
      document.querySelector('.register form').addEventListener('submit', function(e) {
        e.preventDefault();
        const inputs = this.querySelectorAll('input');
        const first_name = inputs[0].value.trim();
        const last_name = inputs[1].value.trim();
        const email = inputs[2].value.trim();
        const password = inputs[3].value;
        fetch('http://localhost:3001/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ first_name, last_name, email, password })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if(data.success) {
            alert('Kayıt başarılı!');
            document.getElementById('register').style.display = 'none';
            setLoggedInUser({ first_name, role: 'user', email });
            // Panel açma
            document.querySelector('.tenant-panel').style.display = 'block';
            showAddHouseBtnForRole('tenant');
            loadTenantReservations(email);
          } else {
            alert(data.message || 'Kayıt başarısız!');
          }
        })
        .catch(function() { alert('Sunucuya bağlanılamadı!'); });
      });
      // Sayfa yüklendiğinde oturum kontrolü ve arayüz güncelle
      window.onload = function() {
        updateAuthUI();
        loadListings();
        // Oturum varsa paneli aç
        const user = getLoggedInUser();
        if (user) {
          if (user.role === 'admin') {
            document.querySelector('.admin-panel').style.display = 'block';
            showAddHouseBtnForRole('admin');
            loadAdminReservations();
          } else if (user.role === 'owner') {
            document.querySelector('.owner-panel').style.display = 'block';
            showAddHouseBtnForRole('owner');
            loadOwnerReservations(user.email);
          } else {
            document.querySelector('.tenant-panel').style.display = 'block';
            showAddHouseBtnForRole('tenant');
            loadTenantReservations(user.email);
          }
        }
      };
    </script>
  </main>
  <footer>
    <p>&copy; 2025 Tiny House Rezervasyon Sistemi</p>
  </footer>
</body>
</html>